<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kiki Moon Collection â€” Fablemarq</title>
<meta name="description" content="Continua l'avventura: acquista subito il prossimo libro della saga Kiki Moon." />
<meta name="theme-color" content="#0b1222" />

<!-- Radice asset (modifica se cambi struttura) -->
<meta name="asset-root" content="../assets" />

<!-- Questi due saranno riallineati a runtime -->
<link rel="icon" href="../assets/logo-fablemarq.png" />
<link rel="preload" as="image" href="../assets/it/cover2.webp" />

<style>
  :root{
    --bg:#0b1222;--ink:#e9edf6;--gold:#E7C25F;--orange:#FF9900;
    --muted:#cfd3e0;--panel:rgba(231,194,95,.06);--panelBorder:rgba(231,194,95,.14)
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  a{text-decoration:none;color:inherit}
  .container{width:min(1100px,92vw);margin:0 auto;padding:20px 0}

  /* Header */
  header .nav{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{flex:0 0 auto}
  .brand img{
    display:block;
    height:40px;           /* cambia qui per ingrandire/ridurre */
    width:auto;
    max-width:none;        /* evita shrink da regole globali */
    image-rendering:-webkit-optimize-contrast;
  }
  .lang-switch{display:inline-flex;gap:6px;margin-left:14px;padding:4px 6px;border:1px solid rgba(231,194,95,.35);border-radius:14px;background:rgba(231,194,95,.10)}
  .lang-switch button{all:unset;cursor:pointer;padding:6px 10px;border-radius:10px;font-weight:700;color:#ffe8b3}
  .lang-switch button.active{background:rgba(231,194,95,.22);box-shadow:0 4px 12px rgba(231,194,95,.18)}

  /* HERO */
  .hero{
    display:grid;grid-template-columns:1fr 1.1fr;gap:20px;align-items:center;
    margin:14px 0 18px;padding:18px;border-radius:18px;
    background:var(--panel);border:1px solid var(--panelBorder);
    box-shadow:0 10px 30px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.04)
  }
  .cover-link{display:block}
  .cover-link .cover{
    display:block;aspect-ratio:2/3;border-radius:14px;object-fit:cover;width:100%;
    background:#0f1730;border:1px solid rgba(231,194,95,.16);cursor:pointer
  }
  .cover-link:hover .cover{filter:brightness(1.02)}

  .hero-title{text-align:center;font-weight:900;margin:0 0 8px}
  .hero-title .line1{display:block;font-size:clamp(22px,4.2vw,34px);color:var(--gold)}
  .hero-title .line2{display:block;font-size:clamp(22px,4.2vw,34px);color:var(--ink)}
  .hook{margin:6px 0 12px;color:#ffe8b3;font-style:italic;text-align:center}

  .benefits{list-style:none;margin:6px 0 12px;padding:0;display:grid;gap:6px;justify-items:center}
  .benefits li{font-size:.98rem;color:#d8dcee;opacity:.95}
  .benefits li::before{content:"âœ“";margin-right:8px;color:var(--gold)}

  .cta{display:flex;justify-content:center;margin:10px 0 8px}
  .amazon-btn{
    display:inline-flex;align-items:center;justify-content:center;
    min-height:56px;padding:14px 28px;border-radius:12px;
    background:#000;border:2px solid var(--gold);
    color:#FF9900;text-transform:lowercase;font-weight:800;font-size:1rem;letter-spacing:.2px;
    box-shadow:0 6px 18px rgba(0,0,0,.25);
    transition:box-shadow .15s ease,transform .12s ease,border-color .15s ease
  }
  .amazon-btn:hover{transform:translateY(-1px);box-shadow:0 10px 28px rgba(0,0,0,.32);border-color:#ffd979}
  .mini-trust{margin:4px 0 12px;font-size:.92rem;color:var(--muted);text-align:center}
  .mini-trust .lock{margin-right:6px}

  .sec-title{margin:18px 0 10px;font-size:1rem;color:#cfd3e0;opacity:.9}
  .posters{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:16px;list-style:none;padding:0;margin:0}
  .posters li{background:var(--panel);border:1px solid var(--panelBorder);border-radius:16px;padding:12px;text-align:center}
  .posters img{width:100%;aspect-ratio:2/3;object-fit:cover;border-radius:12px;background:#0f1730}
  .caption{margin:8px 0 4px;font-weight:800;font-size:.95rem;color:#ffe8b3}
  .meta{margin:0;font-size:.85rem;color:#9aa3b2}

  /* Sticky CTA mobile */
  @media (max-width:520px){
    .sticky-cta{
      position:fixed;bottom:12px;left:50%;transform:translateX(-50%);
      width:min(560px,92vw);
      background:rgba(11,18,34,.85);backdrop-filter:blur(6px);
      border:1px solid rgba(231,194,95,.18);border-radius:14px;
      padding:10px;z-index:50;display:none;
    }
    .sticky-cta .amazon-btn{width:100%}
  }
  @media (max-width:820px){
    .hero{grid-template-columns:1fr;text-align:center;gap:14px}
    .hero .cover{max-width:360px;margin:0 auto 10px}
  }
  @media (max-width:520px){
    .posters{grid-template-columns:1fr;justify-items:center}
    .posters li{width:min(420px,86vw)}
    .amazon-btn{width:100%}
  }
</style>

<script>
/* =========================
   Asset root e utilitÃ 
   ========================= */
const ASSET_ROOT = (()=>{
  const meta = document.querySelector('meta[name="asset-root"]');
  if (meta?.content) return meta.content.replace(/\/+$/,'');
  const p = location.pathname.toLowerCase().replace(/\\/g,'/');
  if (/(^|\/)libro-\d+\//.test(p)) return '../../assets';
  if (/(^|\/)(kikimooncollection|kiki-moon-collection|collection)\//.test(p)) return '../assets';
  return './assets';
})();

/* =========================
   Lingua e store
   ========================= */
function normLang(l){const s=(l||'').toLowerCase();if(s.startsWith('it'))return'it';if(s.startsWith('es'))return'es';return'en';}
(function initLang(){
  const qs=new URLSearchParams(location.search);
  const urlL=qs.get('lang');const saved=localStorage.getItem('lang');
  const nav=(navigator.languages&&navigator.languages[0])||navigator.language||'en';
  const L=normLang(urlL||saved||nav);
  document.documentElement.lang=L;localStorage.setItem('lang',L);
  if(urlL){const u=new URL(location.href);u.searchParams.delete('lang');history.replaceState({},'',u);}
  window.__setLang=function(newL){const L2=normLang(newL);document.documentElement.lang=L2;localStorage.setItem('lang',L2);
    document.querySelectorAll('.lang-switch button').forEach(b=>b.classList.toggle('active',b.dataset.lang===L2));renderPage();};
})();

const AMZ_TLD={IT:'it',ES:'es',FR:'fr',DE:'de',GB:'co.uk',US:'com',CA:'ca',MX:'com.mx',CO:'com.co'};
function suggestStoreFromLang(lang){
  const l=(lang||navigator.language||'en').toLowerCase();
  if(l.includes('-ca'))return'CA';
  if(l.includes('it'))return'IT';
  if(l.includes('fr'))return'FR';
  if(l.includes('de'))return'DE';
  if(l.includes('gb')||l.includes('uk'))return'GB';
  if(l.startsWith('es')){ if(l.includes('-mx'))return'MX'; if(l.includes('-co'))return'CO'; return'ES'; }
  return'US';
}
(function initStoreOnce(){
  if(localStorage.getItem('amz_cc'))return;
  const cc=suggestStoreFromLang((navigator.languages&&navigator.languages[0])||navigator.language);
  localStorage.setItem('amz_cc',cc);
})();

/* =========================
   Dati multilingua e cover
   ========================= */

/* Slug pagine libro per riscrivere i link delle card */
const BOOK_SLUGS={ b1:'libro-1/index.html', b2:'libro-2/index.html', b3:'libro-3/index.html', b4:'libro-4/index.html', b5:'libro-5/index.html', b6:'libro-6/index.html' };

/* Numero libro: b1â†’1 ecc. */
const BOOK_NUM={ b1:1, b2:2, b3:3, b4:4, b5:5, b6:6 };

/* === SOLO WEBP: {ASSET_ROOT}/{lang}/cover{N}.webp === */
function coverPath(lang, code){
  const n = BOOK_NUM[code] || 1;
  return `${ASSET_ROOT}/${lang}/cover${n}.webp`;
}

/* Imposta immagine: solo WebP, nessun fallback JPG */
function setCoverIMG(imgEl, lang, code, title){
  if(!imgEl) return;
  const p = coverPath(lang, code);
  imgEl.src = p;
  imgEl.removeAttribute('srcset');
  imgEl.removeAttribute('sizes');
  if(title) imgEl.alt = title;
}

/* Preload immagine hero coerente */
function updateHeroPreload(lang, code){
  const link=document.querySelector('link[rel="preload"][as="image"]');
  if (link) link.href = coverPath(lang, code);
}

/* Testi localizzati */
const I18N={
  it:{
    buy:"acquista su amazon", metaBuy:"Acquisto e resi gestiti da Amazon.",
    benefits:["80 pagine illustrate","per bambini 6â€“10 anni","stampa di qualitÃ "],
    hooks:{ b2:"Snarfel Ã¨ tornato. E questa volta il segreto Ã¨ piÃ¹ grande della magia.", b3:"Il tempo dorme. Kiki deve risvegliarlo prima che Moon si fermi." },
    titles:{ b1:"Libro I â€” La Stella Perduta", b2:"Libro II â€” Il Segreto di Snarfel", b3:"Libro III â€” La Notte Infinita" },
    metas:{  b1:"Lâ€™inizio dellâ€™avventura",        b2:"Il segreto si rivela",            b3:"Il tempo si Ã¨ fermato" }
  },
  en:{
    buy:"buy on amazon", metaBuy:"Purchase and returns handled by Amazon.",
    benefits:["80 illustrated pages","for kids aged 6â€“10","high-quality print"],
    hooks:{ b2:"Snarfel is back. This time the secret is bigger than magic.", b3:"Time is asleep. Kiki must wake it before Moon stops." },
    titles:{ b1:"Book I â€” The Lost Star", b2:"Book II â€” Snarfelâ€™s Secret", b3:"Book III â€” The Endless Night" },
    metas:{  b1:"The beginning of the journey", b2:"The secret unfolds",     b3:"Time has stopped" }
  },
  es:{
    buy:"comprar en amazon", metaBuy:"Compra y devoluciones gestionadas por Amazon.",
    benefits:["80 pÃ¡ginas ilustradas","para niÃ±os de 6 a 10 aÃ±os","impresiÃ³n de alta calidad"],
    hooks:{ b2:"Snarfel ha vuelto. Y esta vez el secreto es mÃ¡s grande que la magia.", b3:"El tiempo duerme. Kiki debe despertarlo antes de que Moon se detenga." },
    titles:{ b1:"Libro I â€” La Estrella Perdida", b2:"Libro II â€” El Secreto de Snarfel", b3:"Libro III â€” La Noche Infinita" },
    metas:{  b1:"El inicio de la aventura",       b2:"El secreto se revela",             b3:"El tiempo se detuvo" }
  }
};

/* Libri successivi per hero + ASIN (INSERISCI GLI ASIN REALI) */
const NEXT_BOOK={
  b1:{code:'b2',slug:'libro-2/index.html',
      title:{it:'Libro II â€” Il Segreto di Snarfel',en:'Book II â€” Snarfelâ€™s Secret',es:'Libro II â€” El Secreto de Snarfel'},
      asin:{it:'ASIN_LIBRO2_IT',en:'ASIN_LIBRO2_EN',es:'ASIN_LIBRO2_ES'}},
  b2:{code:'b3',slug:'libro-3/index.html',
      title:{it:'Libro III â€” La Notte Infinita',en:'Book III â€” The Endless Night',es:'Libro III â€” La Noche Infinita'},
      asin:{it:'ASIN_LIBRO3_IT',en:'ASIN_LIBRO3_EN',es:'ASIN_LIBRO3_ES'}}
};

/* =========================
   Rendering pagina
   ========================= */
function L(){return localStorage.getItem('lang')||(document.documentElement.lang||'en');}

function buildAmazonUrl(cc,seriesCode,asin,lang){
  const tld=AMZ_TLD[cc]||'com';
  const q=new URLSearchParams(location.search);
  const utm=`utm_source=qr&utm_medium=${seriesCode}_${lang}&utm_campaign=readthrough`;
  const extra=q.get('src')?`&src=${encodeURIComponent(q.get('src'))}`:'';
  return`https://www.amazon.${tld}/dp/${asin}?${utm}${extra}`;
}

function renderPage(){
  const lang=L();document.querySelectorAll('.lang-switch button').forEach(b=>b.classList.toggle('active',b.dataset.lang===lang));
  const dict=I18N[lang]||I18N.en;

  const urlParams=new URLSearchParams(location.search);
  const src=urlParams.get('src')||'b1';
  const nb=NEXT_BOOK[src]||NEXT_BOOK.b1;

  /* HERO: cover localizzata solo WebP */
  const heroTitle=(I18N[lang]?.titles?.[nb.code]) || nb.title?.[lang] || '';
  const heroImg=document.querySelector('#hero img.cover');
  setCoverIMG(heroImg, lang, nb.code, heroTitle);
  updateHeroPreload(lang, nb.code);

  function withParams(path){
    const u=new URL(path,location.href);
    u.searchParams.set('lang',lang);
    if(urlParams.get('src')&&!u.searchParams.get('src'))u.searchParams.set('src',urlParams.get('src'));
    u.hash='anteprima';
    return u.pathname+(u.search?('?'+u.searchParams.toString()):'')+u.hash;
  }
  const coverA=document.getElementById('coverLink');if(coverA&&nb.slug)coverA.href=withParams(nb.slug);

  /* Titolo, hook, benefit */
  const full=dict.titles[nb.code]||nb.title[lang];const parts=full.split('â€”').map(s=>s.trim());
  document.getElementById('titleLine1').textContent=parts[0]||full;
  document.getElementById('titleLine2').textContent=parts[1]||"";
  document.querySelector('[data-bind="hook"]').textContent=dict.hooks[nb.code];
  const bl=document.getElementById('benefits');bl.innerHTML='';dict.benefits.forEach(txt=>{const li=document.createElement('li');li.textContent=txt;bl.appendChild(li);});
  document.querySelectorAll('[data-i18n="buy"]').forEach(el=>el.textContent=dict.buy);
  document.getElementById('buyMeta').innerHTML=`<span class="lock" aria-hidden="true">ðŸ”’</span> ${dict.metaBuy}`;

  /* Pulsanti Amazon */
  const cc=localStorage.getItem('amz_cc')||suggestStoreFromLang(lang);
  const asin=nb.asin[lang]||nb.asin.en;
  const url=buildAmazonUrl(cc,nb.code,asin,lang);
  const mainBtn=document.getElementById('buyNow');const stickyBtn=document.getElementById('buyNowSticky');
  if(mainBtn)mainBtn.href=url;if(stickyBtn)stickyBtn.href=url;

  /* GRIGLIA: nascondi il libro in hero, riscrivi href e localizza immagini/titoli/meta */
  const grid=document.getElementById('gridBooks');
  if(grid){
    const items=Array.from(grid.querySelectorAll('li[data-book]'));
    items.forEach(li=>{li.style.display=li.dataset.book===nb.code?'none':'';});

    items.forEach(li=>{
      const code=li.dataset.book;
      const a=li.querySelector('a.card-link');
      const img=li.querySelector('img');
      const cap=li.querySelector('.caption');
      const mt =li.querySelector('.meta');

      // href
      const slug=BOOK_SLUGS[code];
      if(a&&slug){
        const u=new URL(slug,location.href);
        u.searchParams.set('lang',lang);
        if(urlParams.get('src'))u.searchParams.set('src',urlParams.get('src'));
        a.setAttribute('href', u.pathname + '?' + u.searchParams.toString());
      }

      // cover solo WebP
      const t = I18N[lang]?.titles?.[code] || (img?.alt||'');
      if(img){
        // path localizzato
        img.src = coverPath(lang, code);
        img.removeAttribute('srcset'); img.removeAttribute('sizes');
        if(t) img.alt = t;
      }

      // caption + meta
      if(cap && t) cap.textContent=t;
      const m = I18N[lang]?.metas?.[code];
      if(mt && m) mt.textContent=m;
    });

    // Ordine griglia
    const ORDER_MAP={
      b1:['b2','b3','b4','b5','b6'],
      b2:['b3','b1','b4','b5','b6'],
      b3:['b5','b2','b1','b4','b6'],
      b4:['b5','b3','b2','b1','b6']
    };
    const desired=(ORDER_MAP[nb.code]||[]).filter(code=>{
      const li=grid.querySelector(`li[data-book="${code}"]`);
      return li&&li.style.display!=='none';
    });
    desired.forEach(code=>{
      const li=grid.querySelector(`li[data-book="${code}"]`);
      if(li)grid.appendChild(li);
    });
  }

  initStickyObserver();
}

/* Sticky CTA su mobile */
function initStickyObserver(){
  const wrap=document.getElementById('stickyCta');const btn=document.getElementById('buyNow');
  if(!wrap||!btn)return;
  const mq=window.matchMedia('(max-width:520px)');
  function attach(){
    if(!mq.matches){wrap.style.display='none';return;}
    const io=new IntersectionObserver((entries)=>{
      wrap.style.display=entries[0].isIntersecting?'none':'block';
    },{threshold:0.01});
    io.observe(btn);
  }
  mq.addEventListener?mq.addEventListener('change',attach):mq.addListener(attach);
  attach();
}

/* Bootstrap */
document.addEventListener('DOMContentLoaded', ()=>{
  // logo + favicon allineati alla root
  const logo = document.querySelector('.brand img');
  if (logo) logo.src = `${ASSET_ROOT}/logo-fablemarq.png`; // usa .png se non hai la webp
  const fav = document.querySelector('link[rel="icon"]');
  if (fav) fav.href = `${ASSET_ROOT}/logo-fablemarq.png`;

  renderPage();
});
document.addEventListener('click',(e)=>{
  const b=e.target.closest('.lang-switch button[data-lang]');if(!b)return;
  e.preventDefault();window.__setLang&&window.__setLang(b.dataset.lang);
});
</script>
</head>
<body>
<header>
  <div class="container nav">
    <a class="brand" href="../index.html">
      <!-- Nessun width/height inline: controlliamo tutto da CSS -->
      <img src="../assets/logo-fablemarq.webp" alt="Fablemarq" decoding="async">
    </a>
    <nav>
      <div class="lang-switch" aria-label="Language">
        <button data-lang="en">EN</button>
        <button data-lang="it">IT</button>
        <button data-lang="es">ES</button>
      </div>
    </nav>
  </div>
</header>

<main class="container">
  <section class="hero" id="hero">
    <a id="coverLink" class="cover-link" href="#" title="Anteprima" aria-label="Apri anteprima">
      <!-- Solo WebP, riscritto via JS -->
      <img class="cover" src="../assets/it/cover2.webp" alt="Copertina â€” anteprima" loading="eager" />
    </a>
    <div class="copy">
      <h1 class="hero-title">
        <span class="line1" id="titleLine1">Libro II</span>
        <span class="line2" id="titleLine2">Il Segreto di Snarfel</span>
      </h1>
      <p class="hook" data-bind="hook">Snarfel Ã¨ tornatoâ€¦</p>
      <ul class="benefits" id="benefits">
        <li>80 pagine illustrate</li><li>per bambini 6â€“10 anni</li><li>stampa di qualitÃ </li>
      </ul>
      <div class="cta">
        <a id="buyNow" class="amazon-btn" href="#" target="_blank" rel="noopener nofollow sponsored">
          <span data-i18n="buy">acquista su amazon</span>
        </a>
      </div>
      <p id="buyMeta" class="mini-trust">
        <span class="lock" aria-hidden="true">ðŸ”’</span> Acquisto e resi gestiti da Amazon.
      </p>
    </div>
  </section>

  <div class="sticky-cta" id="stickyCta">
    <a id="buyNowSticky" class="amazon-btn" href="#" target="_blank" rel="noopener nofollow sponsored">
      <span data-i18n="buy">acquista su amazon</span>
    </a>
  </div>

  <h2 class="sec-title">Altri libri della saga</h2>
  <ul class="posters" id="gridBooks">
    <li data-book="b1">
      <a class="card-link" href="#"><img src="../assets/it/cover1.webp" alt="Libro I" loading="lazy"></a>
      <p class="caption">Libro I â€” La Stella Perduta</p>
      <p class="meta">Lâ€™inizio dellâ€™avventura</p>
    </li>
    <li data-book="b2">
      <a class="card-link" href="#"><img src="../assets/it/cover2.webp" alt="Libro II" loading="lazy"></a>
      <p class="caption">Libro II â€” Il Segreto di Snarfel</p>
      <p class="meta">Il segreto si rivela</p>
    </li>
    <li data-book="b3">
      <a class="card-link" href="#"><img src="../assets/it/cover3.webp" alt="Libro III" loading="lazy"></a>
      <p class="caption">Libro III â€” La Notte Infinita</p>
      <p class="meta">Il tempo si Ã¨ fermato</p>
    </li>
    <!-- Futuri -->
    <li data-book="b4" style="display:none">
      <a class="card-link" href="#"><img src="../assets/it/cover4.webp" alt="Libro IV" loading="lazy"></a>
      <p class="caption">Libro IV</p>
      <p class="meta">Prossimamente</p>
    </li>
    <li data-book="b5" style="display:none">
      <a class="card-link" href="#"><img src="../assets/it/cover5.webp" alt="Libro V" loading="lazy"></a>
      <p class="caption">Libro V</p>
      <p class="meta">Prossimamente</p>
    </li>
    <li data-book="b6" style="display:none">
      <a class="card-link" href="#"><img src="../assets/it/cover6.webp" alt="Libro VI" loading="lazy"></a>
      <p class="caption">Libro VI</p>
      <p class="meta">Prossimamente</p>
    </li>
  </ul>
</main>
</body>
</html>
